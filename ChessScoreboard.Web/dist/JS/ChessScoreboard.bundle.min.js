'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var ChessScoreboardConstants=function a(){_classCallCheck(this,a),this.KFactor=100,this.BaseRating=400,this.APIKey='AIzaSyCdkEsPqNU-Xc_7CwQp-kM1hmq_F7rRhgw',this.SpreadsheetId='1EcjGl22n3CaxF9x0BJzPaNBxi8C3C-uMqWsxtmkkFTs',this.ClientId='265091334368-ur3uolm45a8rg391kmuq212neieivkq5.apps.googleusercontent.com',this.AppScriptUrl='https://script.google.com/macros/s/AKfycbwmHZ1RfKVmOlUg6tbMHVQkTMWA-I-guaQm-U1dNiq6-7eisjg/exec',this.PlayersNameIndex=1,this.PlayersRatingIndex=5,this.GamesWinnerIndex=0,this.GamesLoserIndex=1,this.GamesWasStalemateIndex=2},Calculator,GamesTable,PlayersTable,AddGamePlayersTable,ChessScoreboardSheet,Constants=new ChessScoreboardConstants;function init(){Calculator=new RatingCalculator(Constants.KFactor,Constants.BaseRating),ChessScoreboardSheet=new Sheet(Constants.APIKey,Constants.SpreadsheetId,Constants.ClientId,Constants.AppScriptUrl),ChessScoreboardSheet.Connect(function(){ChessScoreboardSheet.UserIsSignedIn&&(GamesTable=new SheetsTable('Games!$B$2:$D$201',ChessScoreboardSheet,'#Games',['#','Winner','Loser','Was Stalemate'],GamesTableRefreshCallback),PlayersTable=new SheetsTable('Players!$A$1:$G$201',ChessScoreboardSheet,'#Players',void 0,PlayersTableRefreshCallback),AddGamePlayersTable=new SheetsTable('Players!$A$2:$B$201',ChessScoreboardSheet,'#AddGamesPlayers',['#','Name']))})}function PlayersTableRefreshCallback(){var a,b=$('#Players tbody tr').length-1;$('#Players tbody td:nth-of-type(1)').each(function(c){a='fa-chess-';0===c?a+='king':1===c?a+='queen':2===c?a+='rook':3===c?a+='bishop':4===c?a+='knight':c===b?a='fa-dumpster-fire':a+='pawn';$(this).empty().prepend('<i class="fas fa-2x text-primary pl-2 '+a+'"></i>')})}function GamesTableRefreshCallback(){$('#Games tbody tr').each(function(a){$(this).prepend('<td class="text-center align-middle">'+(a+1)+'</td>')})}function OpenAddGameModal(a){a.preventDefault(),$('#AddGameModal').modal('show'),$('input').attr('max',AddGamePlayersTable.Values.length)}function AddGameClick(a){a.preventDefault();var b=parseInt($('#WinnerNumber').val()),c=parseInt($('#LoserNumber').val()),d=$('#WasStalemate').prop('checked'),e=AddGamePlayersTable.Values[b-1][1],f=AddGamePlayersTable.Values[c-1][1];GamesTable.AddRow([e,f,d]).then(Recalculate),$('#AddGameModal').modal('hide')}function ToggleUpDownCaret(a){var b;$(a).children('i').each(function(){b=$(this),b.toggleClass('d-none'),b.toggleClass('d-block')})}function RecalculateClick(a){a.preventDefault(),Recalculate()}function Recalculate(){var a=GamesTable.Values,b=PlayersTable.Values;b.shift();for(var c=0;c<b.length;c++)b[c][Constants.PlayersRatingIndex]=Calculator.BaseRating;for(var d,e,f,g,h,c=0;c<a.length;c++){d=FindPlayersIndexByName(b,a[c][Constants.GamesWinnerIndex]),f=b[d][Constants.PlayersRatingIndex],e=FindPlayersIndexByName(b,a[c][Constants.GamesLoserIndex]),g=b[e][Constants.PlayersRatingIndex],h='true'===a[c][Constants.GamesWasStalemateIndex].toString().toLowerCase();var j=Calculator.GetNewRatings(h,new Ratings(f,g));b[d][Constants.PlayersRatingIndex]=j.WinnersRating,b[e][Constants.PlayersRatingIndex]=j.LosersRating}UpdatePlayerRatingsInSpreadsheet(b)}function UpdatePlayerRatingsInSpreadsheet(a){var b=a.map(function(d){return[d[Constants.PlayersRatingIndex]]});PlayersTable.Sheet.Put('Players!$F$2:$F$201',{values:b}).then(function(){PlayersTable.SendGetRequestToAppScriptUrl().always(function(){setTimeout(function(){PlayersTable.Refresh()},100)})})}function FindPlayersIndexByName(a,b){for(var c=0;c<a.length;c++)if(a[c][Constants.PlayersNameIndex].toLowerCase()===b.toLowerCase())return c}var Game=function a(b,c,d){_classCallCheck(this,a),this.WinnersName=b,this.LosersName=c,this.WasStalemate=d},RatingCalculator=function(){function a(b,c){_classCallCheck(this,a),this.KFactor=b?b:100,this.BaseRating=c?c:400}return _createClass(a,[{key:'GetNewRatings',value:function GetNewRatings(b,c){var d=this.GetTransformedRating(c.WinnersRating),e=this.GetTransformedRating(c.LosersRating),f=this.GetExpectedScores(d,e),g=this.GetActualScores(b),h=this.GetNewRating(c.WinnersRating,g.Winners,f.Winners),j=this.GetNewRating(c.LosersRating,g.Losers,f.Losers);return new Ratings(parseFloat(h.toFixed(2)),parseFloat(j.toFixed(2)))}},{key:'GetTransformedRating',value:function GetTransformedRating(b){return Math.pow(10,b/this.BaseRating)}},{key:'GetExpectedScores',value:function GetExpectedScores(b,c){return new Scores(b/(b+c),c/(b+c))}},{key:'GetActualScores',value:function GetActualScores(b){return b?new Scores(.5,.5):new Scores(1,0)}},{key:'GetNewRating',value:function GetNewRating(b,c,d){return b+this.KFactor*(c-d)}},{key:'Round',value:function Round(b,c){return+(Math.round(b+'e'+c)+'e-'+c)}}]),a}(),Ratings=function a(b,c){_classCallCheck(this,a),this.WinnersRating=b,this.LosersRating=c},Scores=function a(b,c){_classCallCheck(this,a),this.Winners=b,this.Losers=c},Sheet=function(){function a(b,c,d,e){_classCallCheck(this,a),this.ApiKey=b,this.ClientID=d,this.SpreadsheetID=c,this.AppScriptUrl=e,this.Scopes='https://www.googleapis.com/auth/spreadsheets',this.DiscoveryDocs=['https://sheets.googleapis.com/$discovery/rest?version=v4'],this.UserIsSignedIn=!1}return _createClass(a,[{key:'Connect',value:function Connect(b){var c=this;gapi.load('client:auth2',function(){var d={apiKey:c.ApiKey,clientId:c.ClientID,discoveryDocs:c.DiscoveryDocs,scope:c.Scopes};gapi.client.init(d).then(function(){gapi.auth2.getAuthInstance().isSignedIn.listen(c.UpdateSignInStatus),c.UpdateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get()),c.UserNeedsToSignIn&&gapi.auth2.getAuthInstance().signIn(),b()},console.error)})}},{key:'UpdateSignInStatus',value:function UpdateSignInStatus(b){this.UserIsSignedIn=b}},{key:'Get',value:function Get(b){return new Promise(function(c,d){gapi.client.sheets.spreadsheets.values.get(b).then(c,d)})}},{key:'Put',value:function Put(b,c){var d={spreadsheetId:this.SpreadsheetID,range:b,valueInputOption:'USER_ENTERED'};return gapi.client.sheets.spreadsheets.values.update(d,c)}},{key:'GetAppScript',value:function GetAppScript(){$.ajax({type:'GET',url:this.AppScriptUrl})}},{key:'UserNeedsToSignIn',get:function get(){return!this.UserIsSignedIn}}]),a}(),faSize='fa fa-2x',faSquare=faSize+' fa-square',faCheckSqare=faSize+' fa-check-square',SheetsTable=function(){function a(b,c,d,e,f){_classCallCheck(this,a),this.Range=b,this.Sheet=c,this.TableSelector=d,this.THeadSelector=this.TableSelector+' thead',this.TBodySelector=this.TableSelector+' tbody',this.RefreshFunction=f,e?(this.Headings=e,this.HeadingsDefinedByUser=!0):this.HeadingsDefinedByUser=!1,this.Refresh()}return _createClass(a,[{key:'Refresh',value:function Refresh(){var b=this;this.RefreshValues().then(function(c){return b.Values=c.result.values,b.Values&&0!=b.Values.length?void b.RefreshTable().then(b.RefreshFunction):(console.warn('No data found for range '+b.Range),void alert('No data found for range '+b.Range))})}},{key:'RefreshValues',value:function RefreshValues(){var b={spreadsheetId:this.Sheet.SpreadsheetID,range:this.Range};return this.Sheet.Get(b)}},{key:'RefreshTable',value:function RefreshTable(){var b=this;return new Promise(function(c){b.Clear();var e=b.HeadingsDefinedByUser?0:1;b.HeadingsDefinedByUser?b.AppendHeaderRow(b.Headings):b.AppendHeaderRow(b.Values[0]);for(var f,g=e;g<b.Values.length;g++)f=b.Values[g],''==f[0]?(b.Values.splice(g,1),g--):b.AppendRow(f);c()})}},{key:'Clear',value:function Clear(){$(this.THeadSelector).empty(),$(this.TBodySelector).empty()}},{key:'AppendHeaderRow',value:function AppendHeaderRow(b){for(var c='',d=0;d<b.length;d++)c+='<th class="text-center">'+b[d]+'</th>';this.AppendTableRow(c,this.THeadSelector)}},{key:'AppendRow',value:function AppendRow(b){for(var c,d='',e=0;e<b.length;e++)c=b[e].toLowerCase(),d+='true'===c||'false'===c?'<td class="text-center text-primary align-middle"><i class="'+('true'==c?faCheckSqare:faSquare)+'"></i></td>':isNaN(c)&&!c.includes('%')?'<td class="align-middle">'+b[e]+'</td>':'<td class="text-center align-middle">'+b[e]+'</td>';this.AppendTableRow(d,this.TBodySelector)}},{key:'AppendTableRow',value:function AppendTableRow(b,c){$(c).append('<tr>'+b+'</tr>')}},{key:'AddRow',value:function AddRow(b){var c=this;return new Promise(function(d){c.Values.push(b);var f={values:c.Values},g=c;c.Sheet.Put(c.Range,f).then(function(){g.SendGetRequestToAppScriptUrl(),g.Refresh()}),d()})}},{key:'SendGetRequestToAppScriptUrl',value:function SendGetRequestToAppScriptUrl(){return $.ajax({url:this.Sheet.AppScriptUrl,type:'GET',dataType:'jsonp'})}}]),a}();